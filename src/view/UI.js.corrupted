export default class UIManager {
    constructor(game) {
        this.game = game;
        this.displayedMoney = 0;
        this.dialogQueue = [];
        this.currentDialog = null;
        this.screens = {
            start: document.getElementById('start-screen'),
            hud: document.getElementById('hud')
        };
        this.panels = {
            manager: document.getElementById('manager-panel')
        };
        this.dialog = document.getElementById('dialog-box');
    }

    init() {
        // Bind Buttons
        document.getElementById('btn-new-game').addEventListener('click', () => {
            this.showScreen('hud'); // Optimistic update
            this.game.startNewGame();
        });

        document.getElementById('btn-load-game').addEventListener('click', () => {
            this.game.loadGame();
        });

        document.getElementById('manager-panel-btn').addEventListener('click', () => {
            this.togglePanel('manager');
        });

        // Pause Button (New)
        const pauseBtn = document.createElement('button');
        pauseBtn.id = 'btn-pause';
        pauseBtn.className = 'pixel-btn';
        pauseBtn.style.position = 'absolute';
        pauseBtn.style.right = '15px';
        pauseBtn.style.top = '15px';
        pauseBtn.style.zIndex = '1000';
        pauseBtn.textContent = 'â¸ï¸';
        pauseBtn.onclick = () => this.game.togglePause();
        document.body.appendChild(pauseBtn);

        document.querySelector('.close-btn').addEventListener('click', () => {
            this.panels.manager.classList.add('hidden');
        });

        // Tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.updateManagerPanel(e.target.dataset.tab);
            });
        });

        // Dialog next button
        document.getElementById('dialog-next').addEventListener('click', () => {
            this.showNextDialog();
        });

        // Status Bar Legend
        const topBar = document.querySelector('.top-bar');
        if (topBar) {
            topBar.style.cursor = 'pointer';
            topBar.addEventListener('click', () => {
                this.toggleStatusLegend();
            });
        }
    }

    showScreen(name) {
        Object.values(this.screens).forEach(s => s.classList.add('hidden'));
        if (this.screens[name]) {
            this.screens[name].classList.remove('hidden');
            this.screens[name].classList.add('active');
        }
    }

    togglePanel(name) {
        const panel = this.panels[name];
        if (panel) {
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                this.updateManagerPanel('inventory'); // Default tab
            }
        }
    }

    updateManagerPanel(tab) {
        const content = document.querySelector('.panel-content');
        content.innerHTML = `<p>Loading ${tab}...</p>`;

        if (tab === 'inventory') {
            this.renderInventory(content);
        } else if (tab === 'employee') {
            this.renderEmployee(content);
        } else if (tab === 'shop') {
            this.renderShop(content);
        } else {
            content.innerHTML = `<p>${tab} åŠŸèƒ½æš‚æœªå¼€æ”¾</p>`;
        }
    }

    renderInventory(container) {
        const inventory = this.game.state.shop.inventory;
        let html = '<div class="inventory-list">';
        inventory.items.forEach(item => {
            html += `
                <div class="inv-item" style="border: 1px solid #777; padding: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight:bold;">${item.name}</div>
                        <div style="font-size: 12px;">åº“å­˜: ${item.quantity} | æˆæœ¬: ${item.cost} | å”®ä»·: ${item.price}</div>
                    </div>
                    <div>
                        <button class="pixel-btn small" onclick="window.game.ui.handleRestock('${item.id}')">è¡¥è´§</button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    handleRestock(itemId) {
        const item = this.game.state.shop.inventory.items.find(i => i.id === itemId);
        if (item) {
            const cost = item.cost * 5; // Restock 5
            if (this.game.state.shop.money >= cost) {
                this.game.state.shop.money -= cost;

                // Add to pending orders
                this.game.state.shop.pendingOrders.push({ itemId: itemId, quantity: 5 });

                this.updateManagerPanel('inventory');
                this.updateHUD(this.game.state);
                this.showDialog(`å·²ä¸‹å• ${item.name} x5ï¼ŒèŠ±è´¹ ${cost} é‡‘å¸ (æ˜æ—¥é€è¾¾)`);
            } else {
                this.showDialog("èµ„é‡‘ä¸è¶³ï¼");
            }
        }
    }

    renderEmployee(container) {
        const emp = this.game.state.employees[0];
        if (!emp) return;

        container.innerHTML = `
            <div class="emp-details">
                <h3>${emp.name} (Lv.${emp.level})</h3>
                <p>å²—ä½: ${emp.role}</p>
                <p>ç»éªŒ: ${emp.xp}/${emp.xpToNextLevel}</p>
                <p>æ•ˆç‡: ${emp.efficiency}%</p>
                <p>äº²å’ŒåŠ›: ${emp.charisma}%</p>
                <p>ç–²åŠ³: ${Math.floor(emp.fatigue)}/100</p>
                <hr>
                <div style="margin-bottom: 10px;">
                    <label>å½“å‰ä»»åŠ¡ä¼˜å…ˆçº§:</label>
                    <select id="emp-task-select" onchange="window.game.ui.handleTaskChange(this.value)">
                        <option value="balanced" ${emp.taskPriority === 'balanced' ? 'selected' : ''}>å‡è¡¡å·¥ä½œ</option>
                        <option value="guide" ${emp.taskPriority === 'guide' ? 'selected' : ''}>ä¼˜å…ˆå¯¼è´­</option>
                        <option value="cashier" ${emp.taskPriority === 'cashier' ? 'selected' : ''}>ä¼˜å…ˆæ”¶é“¶</option>
                    </select>
                </div>
                <button class="pixel-btn small" onclick="window.game.ui.handleRest()">ä¼‘æ¯ (-20ç–²åŠ³)</button>
                <button class="pixel-btn small" onclick="window.game.ui.handleMotivate()">æ¿€åŠ± (+10%æ•ˆç‡)</button>
            </div>
        `;
    }

    renderShop(container) {
        const shop = this.game.state.shop;
        container.innerHTML = `
            <div class="shop-details">
                <h3>åº—é“ºä¿¡æ¯</h3>
                <p>æ˜æ—¥å¤©æ°”é¢„æŠ¥: ${this.getWeatherEmoji(this.game.state.forecast)}</p>
                <hr>
                <p>ç­‰çº§: ${shop.level}</p>
                <p>å£°æœ›: ${shop.reputation}</p>
                <p>å®¢æµ: ${shop.traffic}</p>
                <hr>
                <h4>å‡çº§åº—é“º</h4>
                <p>ä¸‹ä¸€çº§è´¹ç”¨: ${shop.upgradeCost}</p>
                <button class="pixel-btn" onclick="window.game.ui.handleUpgrade()">å‡çº§åº—é“º</button>
                <hr>
                <h4>è£…ä¿®</h4>
                <button class="pixel-btn" onclick="window.game.state.toggleEditMode(); window.game.ui.togglePanel('manager')">è¿›å…¥è£…ä¿®æ¨¡å¼</button>
            </div>
        `;
    }

    handleUpgrade() {
        const shop = this.game.state.shop;
        if (shop.upgrade()) {
            this.updateManagerPanel('shop');
            this.updateHUD(this.game.state);
            this.showDialog(`åº—é“ºå‡çº§æˆåŠŸï¼å½“å‰ç­‰çº§: ${shop.level}`);
        } else {
            this.showDialog(`èµ„é‡‘ä¸è¶³ï¼éœ€è¦ ${shop.upgradeCost} é‡‘å¸`);
        }
    }

    handleTaskChange(val) {
        const emp = this.game.state.employees[0];
        emp.taskPriority = val;
        this.showDialog(`å°è¡£çš„å·¥ä½œé‡å¿ƒè°ƒæ•´ä¸ºï¼š${val === 'balanced' ? 'å‡è¡¡' : val === 'guide' ? 'å¯¼è´­' : 'æ”¶é“¶'}`);
    }

    handleRest() {
        const emp = this.game.state.employees[0];
        if (emp.fatigue >= 20) {
            emp.fatigue -= 20;
            this.updateManagerPanel('employee');
            this.showDialog("å°è¡£ä¼‘æ¯äº†ä¸€ä¼šå„¿ï¼Œç²¾ç¥å¤šäº†ï¼");
        } else {
            this.showDialog("å°è¡£è¿˜ä¸ç´¯å‘¢ã€‚");
        }
    }

    handleMotivate() {
        if (this.game.state.shop.money >= 50) {
            this.game.state.shop.money -= 50;
            const emp = this.game.state.employees[0];
            emp.efficiency += 10;
            this.updateManagerPanel('employee');
            this.updateHUD(this.game.state);
            this.showDialog("æ™¨ä¼šæ¿€åŠ±ï¼å°è¡£å¹²åŠ²åè¶³ï¼(æ•ˆç‡+10%)");
        } else {
            this.showDialog("èµ„é‡‘ä¸è¶³ (éœ€è¦ 50 é‡‘å¸)");
        }
    }

    showDialog(text) {
        // Add to queue
        if (Array.isArray(text)) {
            this.dialogQueue.push(...text);
        } else {
            this.dialogQueue.push(text);
        }

        // Start showing if not already showing
        if (!this.currentDialog) {
            this.showNextDialog();
        }
    }

    showNextDialog() {
        if (this.dialogQueue.length === 0) {
            this.dialog.classList.add('hidden');
            this.currentDialog = null;
            return;
        }

        this.currentDialog = this.dialogQueue.shift();
        this.dialog.classList.remove('hidden');
        document.getElementById('dialog-text').textContent = this.currentDialog;
    }

    updateHUD(state) {
        // Number Rolling
        const diff = state.shop.money - this.displayedMoney;
        if (Math.abs(diff) > 0) {
            this.displayedMoney += Math.ceil(diff * 0.1); // Ease in
        }
        document.getElementById('money-display').textContent = this.displayedMoney;

        document.getElementById('traffic-display').textContent = state.shop.traffic;

        const seasonMap = { spring: 'ğŸŒ¸', summer: 'â˜€ï¸', autumn: 'ğŸ‚', winter: 'â„ï¸' };
        document.getElementById('season-display').textContent = seasonMap[state.season] + ` Day ${state.day}`;

        // Format time
        const hours = Math.floor(state.time / 60);
        const mins = Math.floor(state.time % 60);
        const timeStr = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        document.getElementById('time-display').innerHTML = `<span style="color:#FFD700">â°</span> ${timeStr}`;

        // Update other stats with icons
        document.getElementById('money-display').innerHTML = `<span style="color:#FFD700">ğŸ’°</span> ${this.displayedMoney}`;

        // Fix: Use dailyStats.visitors for real-time visitor count
        document.getElementById('traffic-display').innerHTML = `<span style="color:#42A5F5">ğŸ‘¥</span> ${state.dailyStats.visitors}`;

        // New Stats
        document.getElementById('sales-display').innerHTML = `<span style="color:#66BB6A">ğŸ›’</span> ${state.dailyStats.sales}`;
        document.getElementById('revenue-display').innerHTML = `<span style="color:#FFA726">ğŸ“ˆ</span> ${state.dailyStats.revenue}`;

        // Update Employee Status Window
        const selectedEmp = this.game.selectedEntity;
        const statusWindow = document.getElementById('employee-status');

        if (selectedEmp && selectedEmp.constructor.name === 'Employee') {
            statusWindow.classList.remove('hidden');
            // Update content
            statusWindow.querySelector('.status-header').textContent = selectedEmp.name;
            document.getElementById('emp-task').textContent = selectedEmp.state;
            document.getElementById('emp-efficiency').textContent = Math.floor(selectedEmp.efficiency) + '%';
            document.getElementById('emp-fatigue').textContent = Math.floor(selectedEmp.fatigue) + '/100';
        } else {
            statusWindow.classList.add('hidden');
        }
    }

    showDailySummary(stats, forecast) {
        const weatherMap = { sunny: 'â˜€ï¸', cloudy: 'â˜ï¸', rainy: 'ğŸŒ§ï¸', snowy: 'â„ï¸' };
        const div = document.createElement('div');
        div.className = 'screen active';
        div.style.backgroundColor = 'rgba(0,0,0,0.9)';
        div.style.zIndex = '100';
        div.innerHTML = `
            <div style="text-align: center; color: white; padding: 20px;">
                <h2>ä»Šæ—¥è¥ä¸šæ€»ç»“</h2>
                <p>å®¢æµ: ${stats.visitors}</p>
                <p>æˆäº¤: ${stats.sales}</p>
                <p>è¥æ”¶: ${stats.revenue}</p>
                <hr style="margin: 20px 0; border-color: #666;">
                <h3>ğŸ“… æ˜æ—¥å¤©æ°”é¢„æŠ¥</h3>
                <p style="font-size: 32px;">${weatherMap[forecast]}</p>
                <p style="font-size: 14px; color: #aaa;">æ™šé—´æ—¶æ®µå¯ç»§ç»­è¡¥è´§å’Œä¸Šæ¶æ“ä½œ</p>
                <br>
                <button class="pixel-btn" onclick="this.closest('.screen').remove()">å…³é—­</button>
            </div>
        `;
        document.body.appendChild(div);
    }

    showEditorToolbar() {
        // Hide other UI
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('manager-panel-btn').classList.add('hidden');
        const pauseBtn = document.getElementById('btn-pause');
        if (pauseBtn) pauseBtn.style.display = 'none';

        let toolbar = document.getElementById('editor-toolbar');
        if (!toolbar) {
            toolbar = document.createElement('div');
            toolbar.id = 'editor-toolbar';
            toolbar.style.position = 'absolute';
            toolbar.style.bottom = '20px';
            toolbar.style.left = '50%';
            toolbar.style.transform = 'translateX(-50%)';
            toolbar.style.background = 'rgba(255, 255, 255, 0.9)';
            toolbar.style.padding = '10px';
            toolbar.style.borderRadius = '12px';
            toolbar.style.display = 'flex';
            toolbar.style.gap = '10px';
            toolbar.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
            toolbar.innerHTML = `
                <button class="pixel-btn small" onclick="window.game.state.toggleEditMode()">é€€å‡ºè£…ä¿®</button>
                <div style="width: 1px; background: #ccc;"></div>
                <button class="pixel-btn small" onclick="window.game.ui.showFurnitureShop()">â• æ·»åŠ å®¶å…·</button>
                <button class="pixel-btn small" style="background: #EF5350;" onclick="window.game.state.removeFurniture()">ğŸ—‘ï¸ åˆ é™¤</button>
            `;
            document.body.appendChild(toolbar);
        }
        toolbar.classList.remove('hidden');
    }

    showFurnitureShop() {
        const div = document.createElement('div');
        div.className = 'screen active';
        div.style.backgroundColor = 'rgba(0,0,0,0.8)';
        div.style.zIndex = '200';
        div.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; width: 300px;">
                <h3>å®¶å…·å•†åº—</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div class="shop-item" onclick="window.game.state.addFurniture('rack'); this.closest('.screen').remove();">
                        <div style="font-size: 24px;">ğŸ‘”</div>
                        <div>è¡£æ¶</div>
                        <div style="color: gold;">200G</div>
                    </div>
                    <div class="shop-item" onclick="window.game.state.addFurniture('shelf'); this.closest('.screen').remove();">
                        <div style="font-size: 24px;">ğŸ“¦</div>
                        <div>è´§æ¶</div>
                        <div style="color: gold;">300G</div>
                    </div>
                    <div class="shop-item" onclick="window.game.state.addFurniture('plant'); this.closest('.screen').remove();">
                        <div style="font-size: 24px;">ğŸª´</div>
                        <div>ç›†æ ½</div>
                        <div style="color: gold;">50G</div>
                    </div>
                </div>
                <br>
                <button class="pixel-btn" onclick="this.closest('.screen').remove()">å…³é—­</button>
            </div>
        `;
        document.body.appendChild(div);
    }

    hideEditorToolbar() {
        const toolbar = document.getElementById('editor-toolbar');
        if (toolbar) {
            toolbar.classList.add('hidden');
        }

        // Show other UI
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('manager-panel-btn').classList.remove('hidden');
        const pauseBtn = document.getElementById('btn-pause');
        if (pauseBtn) pauseBtn.style.display = 'block';
    }
    showFurniturePanel(furniture) {
        const panel = document.getElementById('furniture-panel');
        if (!panel) {
            // Should be in HTML, but if not, we can't show it
            console.error('Furniture panel not found in HTML');
            return;
        }

        this.renderFurniturePanel(furniture);
        panel.classList.remove('hidden');
    }

    renderFurniturePanel(furniture) {
        const content = document.getElementById('furniture-panel-content');
        if (!content) return;

        const item = furniture.itemType ?
            this.game.state.shop.inventory.items.find(i => i.id === furniture.itemType) :
            null;

        let html = `
            <div class="furniture-info">
                <h3>${furniture.type === 'rack' ? 'è¡£æ¶' : 'è´§æ¶'}</h3>
                <p>ä½ç½®: (${furniture.x}, ${furniture.y})</p>
                <p>å®¹é‡: ${furniture.currentStock || 0} / ${furniture.capacity || 10}</p>
            </div>
            <hr>
        `;

        if (item) {
            html += `
                <div class="current-item">
                    <h4>å½“å‰å•†å“</h4>
                    <p><strong>${item.name}</strong></p>
                    <p>è´§æ¶åº“å­˜: ${furniture.currentStock || 0}</p>
                    <p>ä»“åº“åº“å­˜: ${item.quantity}</p>
                    <p>æˆæœ¬: ${item.cost} | å”®ä»·: ${item.price}</p>
                    <button class="pixel-btn small" onclick="window.game.ui.manualRestock('${furniture.type}', ${furniture.x}, ${furniture.y})">
                        æ‰‹åŠ¨è¡¥è´§
                    </button>
                </div>
                <hr>
            `;
        }

        html += `
            <div class="item-selection">
                <button class="pixel-btn" style="width:100%" onclick="window.game.ui.showItemSelector('${furniture.type}', ${furniture.x}, ${furniture.y})">
                    æ›´æ¢å±•ç¤ºå•†å“
                </button>
            </div>
        `;

        content.innerHTML = html;
    }

    showItemSelector(type, x, y) {
        const div = document.createElement('div');
        div.className = 'screen active';
        div.style.backgroundColor = 'rgba(0,0,0,0.8)';
        div.style.zIndex = '300';
        div.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 10px; width: 320px; max-height: 80vh; display: flex; flex-direction: column;">
                <h3>é€‰æ‹©å•†å“</h3>
                <div style="flex: 1; overflow-y: auto; margin: 10px 0;">
                    <div class="item-grid">
                        ${this.game.state.shop.inventory.items.map(item => `
                            <div class="item-card" onclick="window.game.ui.assignItemToFurniture('${type}', ${x}, ${y}, '${item.id}'); this.closest('.screen').remove();">
                                <div class="item-name">${item.name}</div>
                                <div class="item-stats">åº“å­˜: ${item.quantity}</div>
                                <div class="item-stats">å”®ä»·: ${item.price}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <button class="pixel-btn" onclick="this.closest('.screen').remove()">å–æ¶ˆ</button>
            </div>
        `;
        document.body.appendChild(div);
    }

    assignItemToFurniture(type, x, y, itemId) {
        const furniture = this.game.state.shop.facilities.find(f =>
            f.type === type && f.x === x && f.y === y
        );

        if (furniture) {
            furniture.itemType = itemId;
            furniture.currentStock = 0;  // Reset stock when changing item
            this.renderFurniturePanel(furniture);
            this.showDialog(`å·²è®¾ç½®ä¸º: ${itemId}`);
        }
    }

    manualRestock(type, x, y) {
        const furniture = this.game.state.shop.facilities.find(f =>
            f.type === type && f.x === x && f.y === y
        );

        if (furniture) {
            const restocked = this.game.state.shop.restockRack(furniture);
            if (restocked > 0) {
                this.renderFurniturePanel(furniture);
                this.showDialog(`è¡¥è´§æˆåŠŸ: +${restocked}`);
            } else {
                this.showDialog('ä»“åº“åº“å­˜ä¸è¶³!');
            }
        }
    }

    getWeatherEmoji(weather) {
        const map = { sunny: 'â˜€ï¸', cloudy: 'â˜ï¸', rainy: 'ğŸŒ§ï¸', snowy: 'â„ï¸' };
        return map[weather] || weather;
    }

        `;
        document.body.appendChild(div);
    }

    showEditorToolbar() {
        // Hide other UI
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('manager-panel-btn').classList.add('hidden');
        const pauseBtn = document.getElementById('btn-pause');
        if (pauseBtn) pauseBtn.style.display = 'none';

        let toolbar = document.getElementById('editor-toolbar');
        if (!toolbar) {
            toolbar = document.createElement('div');
            toolbar.id = 'editor-toolbar';
            toolbar.style.position = 'absolute';
            toolbar.style.bottom = '20px';
            toolbar.style.left = '50%';
            toolbar.style.transform = 'translateX(-50%)';
            toolbar.style.background = 'rgba(255, 255, 255, 0.9)';
            toolbar.style.padding = '10px';
            toolbar.style.borderRadius = '12px';
            toolbar.style.display = 'flex';
            toolbar.style.gap = '10px';
            toolbar.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
            toolbar.innerHTML = `
    < button class="pixel-btn small" onclick = "window.game.state.toggleEditMode()" > é€€å‡ºè£…ä¿®</button >
                <div style="width: 1px; background: #ccc;"></div>
                <button class="pixel-btn small" onclick="window.game.ui.showFurnitureShop()">â• æ·»åŠ å®¶å…·</button>
                <button class="pixel-btn small" style="background: #EF5350;" onclick="window.game.state.removeFurniture()">ğŸ—‘ï¸ åˆ é™¤</button>
`;
            document.body.appendChild(toolbar);
        }
        toolbar.classList.remove('hidden');
    }

    showFurnitureShop() {
        const div = document.createElement('div');
        div.className = 'screen active';
        div.style.backgroundColor = 'rgba(0,0,0,0.8)';
        div.style.zIndex = '200';
        div.innerHTML = `
    < div style = "background: white; padding: 20px; border-radius: 10px; text-align: center; width: 300px;" >
                <h3>å®¶å…·å•†åº—</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div class="shop-item" onclick="window.game.state.addFurniture('rack'); this.closest('.screen').remove();">
                        <div style="font-size: 24px;">ğŸ‘”</div>
                        <div>è¡£æ¶</div>
                        <div style="color: gold;">200G</div>
                    </div>
                    <div class="shop-item" onclick="window.game.state.addFurniture('shelf'); this.closest('.screen').remove();">
                        <div style="font-size: 24px;">ğŸ“¦</div>
                        <div>è´§æ¶</div>
                        <div style="color: gold;">300G</div>
                    </div>
                    <div class="shop-item" onclick="window.game.state.addFurniture('plant'); this.closest('.screen').remove();">
                        <div style="font-size: 24px;">ğŸª´</div>
                        <div>ç›†æ ½</div>
                        <div style="color: gold;">50G</div>
                    </div>
                </div>
                <br>
                <button class="pixel-btn" onclick="this.closest('.screen').remove()">å…³é—­</button>
            </div>
`;
        document.body.appendChild(div);
    }

    hideEditorToolbar() {
        const toolbar = document.getElementById('editor-toolbar');
        if (toolbar) {
            toolbar.classList.add('hidden');
        }

        // Show other UI
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('manager-panel-btn').classList.remove('hidden');
        const pauseBtn = document.getElementById('btn-pause');
        if (pauseBtn) pauseBtn.style.display = 'block';
    }
    showFurniturePanel(furniture) {
        const panel = document.getElementById('furniture-panel');
        if (!panel) {
            // Should be in HTML, but if not, we can't show it
            console.error('Furniture panel not found in HTML');
            return;
        }

        this.renderFurniturePanel(furniture);
        panel.classList.remove('hidden');
    }

    renderFurniturePanel(furniture) {
        const content = document.getElementById('furniture-panel-content');
        if (!content) return;

        const item = furniture.itemType ?
            this.game.state.shop.inventory.items.find(i => i.id === furniture.itemType) :
            null;

        let html = `
    < div class="furniture-info" >
                <h3>${furniture.type === 'rack' ? 'è¡£æ¶' : 'è´§æ¶'}</h3>
                <p>ä½ç½®: (${furniture.x}, ${furniture.y})</p>
                <p>å®¹é‡: ${furniture.currentStock || 0} / ${furniture.capacity || 10}</p>
            </div >
    <hr>
        `;

        if (item) {
            html += `
                <div class="current-item">
                    <h4>å½“å‰å•†å“</h4>
                    <p><strong>${item.name}</strong></p>
                    <p>è´§æ¶åº“å­˜: ${furniture.currentStock || 0}</p>
                    <p>ä»“åº“åº“å­˜: ${item.quantity}</p>
                    <p>æˆæœ¬: ${item.cost} | å”®ä»·: ${item.price}</p>
                    <button class="pixel-btn small" onclick="window.game.ui.manualRestock('${furniture.type}', ${furniture.x}, ${furniture.y})">
                        æ‰‹åŠ¨è¡¥è´§
                    </button>
                </div>
                <hr>
            `;
        }

        html += `
        <div class="item-selection">
            <button class="pixel-btn" style="width:100%" onclick="window.game.ui.showItemSelector('${furniture.type}', ${furniture.x}, ${furniture.y})">
                æ›´æ¢å±•ç¤ºå•†å“
            </button>
        </div>
        `;

        content.innerHTML = html;
    }

        showItemSelector(type, x, y) {
        const div = document.createElement('div');
        div.className = 'screen active';
        div.style.backgroundColor = 'rgba(0,0,0,0.8)';
        div.style.zIndex = '300';
        div.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 10px; width: 320px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3>é€‰æ‹©å•†å“</h3>
            <div style="flex: 1; overflow-y: auto; margin: 10px 0;">
                <div class="item-grid">
                    ${this.game.state.shop.inventory.items.map(item => `
                            <div class="item-card" onclick="window.game.ui.assignItemToFurniture('${type}', ${x}, ${y}, '${item.id}'); this.closest('.screen').remove();">
                                <div class="item-name">${item.name}</div>
                                <div class="item-stats">åº“å­˜: ${item.quantity}</div>
                                <div class="item-stats">å”®ä»·: ${item.price}</div>
                            </div>
                        `).join('')}
                </div>
            </div>
            <button class="pixel-btn" onclick="this.closest('.screen').remove()">å–æ¶ˆ</button>
        </div>
        `;
        document.body.appendChild(div);
    }

        assignItemToFurniture(type, x, y, itemId) {
        const furniture = this.game.state.shop.facilities.find(f =>
        f.type === type && f.x === x && f.y === y
        );

        if (furniture) {
            furniture.itemType = itemId;
        furniture.currentStock = 0;  // Reset stock when changing item
        this.renderFurniturePanel(furniture);
        this.showDialog(`å·²è®¾ç½®ä¸º: ${itemId}`);
        }
    }

        manualRestock(type, x, y) {
        const furniture = this.game.state.shop.facilities.find(f =>
        f.type === type && f.x === x && f.y === y
        );

        if (furniture) {
            const restocked = this.game.state.shop.restockRack(furniture);
            if (restocked > 0) {
            this.renderFurniturePanel(furniture);
        this.showDialog(`è¡¥è´§æˆåŠŸ: +${restocked}`);
            } else {
            this.showDialog('ä»“åº“åº“å­˜ä¸è¶³!');
            }
        }
    }

        getWeatherEmoji(weather) {
        const map = {sunny: 'â˜€ï¸', cloudy: 'â˜ï¸', rainy: 'ğŸŒ§ï¸', snowy: 'â„ï¸' };
        return map[weather] || weather;
    }

        toggleStatusLegend() {
            let legend = document.getElementById('status-legend');
        if (!legend) {
            legend = document.createElement('div');
        legend.id = 'status-legend';
        legend.style.position = 'absolute';
        legend.style.top = '60px';
        legend.style.left = '50%';
        legend.style.transform = 'translateX(-50%)';
        legend.style.backgroundColor = 'rgba(255, 255, 255, 0.85)'; // Semi-transparent white
        legend.style.color = '#333';
        legend.style.padding = '6px 12px';
        legend.style.borderRadius = '12px';
        legend.style.zIndex = '2000';
        legend.style.fontSize = '12px';
        legend.style.border = '1px solid rgba(0, 0, 0, 0.1)';
        legend.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        legend.style.whiteSpace = 'nowrap';
        legend.style.cursor = 'pointer';
        legend.classList.add('hidden');

            // Stop event propagation to prevent triggering status bar click
            legend.addEventListener('click', (e) => {
            e.stopPropagation();
        this.toggleStatusLegend();
            });

        document.getElementById('hud').appendChild(legend);
        }

        if (legend.classList.contains('hidden')) {
            // Update content
            const state = this.game.state;

        // Format time
        const hours = Math.floor(state.time / 60);
        const mins = Math.floor(state.time % 60);
        const timeStr = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;

        // Single line, text only, no emojis
        legend.textContent = `æ—¶é—´: ${timeStr} | å¤©æ°”: ${state.weather} | èµ„é‡‘: ${Math.floor(state.shop.money)} | å®¢æµ: ${state.dailyStats.visitors} | æˆäº¤: ${state.dailyStats.sales} | è¥æ”¶: ${state.dailyStats.revenue}`;

        legend.classList.remove('hidden');
        } else {
            legend.classList.add('hidden');
        }
    }
}
